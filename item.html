<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cart â€” Generate Receipt</title>
<link rel="icon" href="data:,">
<style>
body{margin:0;font-family:Segoe UI,system-ui,Arial;background:#f7f9fc;color:#111}
header{position:sticky;top:0;background:#0d6efd;color:#fff;padding:12px 14px;text-align:center}
.container{padding:14px 14px 110px}
.item{background:#fff;border-radius:10px;padding:10px;margin-bottom:8px;display:flex;justify-content:space-between;box-shadow:0 6px 12px rgba(2,6,23,0.04)}
.total-box{background:#fff;border-radius:10px;padding:12px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 12px rgba(2,6,23,0.04)}
.note{color:#666;margin-top:12px;text-align:center}
.footer{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#fff;border-top:1px solid #e6e6e6;display:flex;gap:10px}
.btn{flex:1;padding:10px;border-radius:8px;border:0;cursor:pointer}
.btn-secondary{background:#6c757d;color:#fff}
.btn-primary{background:#0d6efd;color:#fff}
.receipt-area{ /* styling the area we will screenshot */
  padding:10px;
  border-radius:8px;
  background:linear-gradient(180deg,#fff,#fbfdff);
}
.store-header{text-align:center;margin-bottom:8px}
.small{font-size:13px;color:#555}
</style>
</head>
<body>
<header>ðŸ§¾ Cart & Auto Receipt</header>

<main class="container">
  <div id="receipt" class="receipt-area">
    <div class="store-header">
      <h3 style="margin:2px 0">Bernie's Store</h3>
      <div class="small" id="receiptDate"></div>
      <hr>
    </div>

    <div id="itemsList"></div>

    <div class="total-box" id="totalBox">
      <div class="small">TOTAL</div>
      <div style="font-weight:700" id="totalText">â‚±0.00</div>
    </div>
  </div>

  <p class="note" id="statusNote">Preparing receipt and saving image automatically...</p>
</main>

<div class="footer">
  <button class="btn btn-secondary" onclick="location.href='index.html'">Cancel</button>
  <button id="manualSave" class="btn btn-primary">Save & Send Now</button>
</div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* Load cart and render receipt area */
function loadCartForReceipt(){
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const itemsList = document.getElementById('itemsList');
  const totalText = document.getElementById('totalText');
  const dateEl = document.getElementById('receiptDate');
  const status = document.getElementById('statusNote');

  itemsList.innerHTML = '';
  let total = 0;
  if(cart.length === 0){
    itemsList.innerHTML = '<div class="small">No items in cart.</div>';
    status.textContent = 'Cart is empty â€” returning to Home...';
    setTimeout(()=> location.href='index.html',1400);
    return;
  }

  cart.forEach((it, idx)=>{
    total += Number(it.price) * (it.qty || 1);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<div>${idx+1}. ${it.name} <div class="small">x${it.qty||1}</div></div><div>â‚±${(Number(it.price)*(it.qty||1)).toFixed(2)}</div>`;
    itemsList.appendChild(div);
  });

  totalText.textContent = 'â‚±' + total.toFixed(2);
  dateEl.textContent = new Date().toLocaleString();

  // Prepare summary object for sending
  const summary = {date: new Date().toLocaleString(), total: total, items: cart};
  localStorage.setItem('last_order_summary', JSON.stringify(summary));

  // Trigger auto-save screenshot after short delay
  setTimeout(()=> autoSaveReceiptImage(), 1400);
}

/* Save screenshot as PNG (auto) and store dataURL in localStorage then redirect to send.html */
function autoSaveReceiptImage(){
  const status = document.getElementById('statusNote');
  status.textContent = 'Generating image receipt...';
  html2canvas(document.querySelector('#receipt'), {scale: 2}).then(canvas=>{
    // convert to dataURL (base64)
    const dataURL = canvas.toDataURL('image/png');
    // trigger download automatically
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = 'receipt_' + Date.now() + '.png';
    document.body.appendChild(link);
    link.click();
    link.remove();

    // save dataURL into localStorage for send.html to pick up (trim large memory if needed)
    try {
      localStorage.setItem('receipt_image_data', dataURL);
    } catch(e){
      // if localStorage quota problem, fallback: store in sessionStorage
      sessionStorage.setItem('receipt_image_data', dataURL);
    }

    status.textContent = 'Receipt saved locally. Preparing to send...';

    // Clear cart (we keep last_order_summary for reference)
    localStorage.removeItem('cart');

    // Small delay then redirect to send.html where user will input name/address/phone
    setTimeout(()=> location.href='send.html', 900);
  }).catch(err=>{
    console.error(err);
    status.textContent = 'Failed to generate image â€” try manual save.';
  });
}

/* Manual button (if user wants immediate action without waiting) */
document.getElementById('manualSave').addEventListener('click', ()=>{
  autoSaveReceiptImage();
});

loadCartForReceipt();
</script>
</body>
</html>